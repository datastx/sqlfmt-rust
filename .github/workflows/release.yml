name: Release

on:
  push:
    branches: [main]
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build - ${{ matrix.target }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: true
      matrix:
        include:
          - target: x86_64-unknown-linux-musl
            runner: ubuntu-latest
            archive: tar.gz
          - target: aarch64-unknown-linux-musl
            runner: ubuntu-latest
            archive: tar.gz
          - target: x86_64-apple-darwin
            runner: macos-13
            archive: tar.gz
          - target: aarch64-apple-darwin
            runner: macos-latest
            archive: tar.gz

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ matrix.target }}-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ matrix.target }}-release-

      # Install musl tools for Linux static builds
      - name: Install musl tools (x86_64)
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: sudo apt-get update && sudo apt-get install -y musl-tools

      - name: Install musl cross-compiler (aarch64)
        if: matrix.target == 'aarch64-unknown-linux-musl'
        run: |
          sudo apt-get update && sudo apt-get install -y musl-tools
          sudo apt-get install -y gcc-aarch64-linux-gnu
          mkdir -p .cargo
          cat >> .cargo/config.toml <<EOF
          [target.aarch64-unknown-linux-musl]
          linker = "aarch64-linux-gnu-gcc"
          rustflags = ["-C", "target-feature=+crt-static"]
          EOF

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }}

      - name: Determine version
        id: version
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Package artifact
        run: |
          BINARY_NAME=sqlfmt
          ARCHIVE_NAME="${BINARY_NAME}-v${{ steps.version.outputs.version }}-${{ matrix.target }}"
          mkdir -p "staging/${ARCHIVE_NAME}"
          cp "target/${{ matrix.target }}/release/${BINARY_NAME}" "staging/${ARCHIVE_NAME}/"
          cp README.md LICENSE* 2>/dev/null "staging/${ARCHIVE_NAME}/" || true
          cd staging
          tar czf "../${ARCHIVE_NAME}.tar.gz" "${ARCHIVE_NAME}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sqlfmt-${{ matrix.target }}
          path: "*.tar.gz"
          retention-days: 7

  release:
    name: Create Release
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Verify all platform artifacts are present
        run: |
          EXPECTED=(
            "sqlfmt-v${{ steps.version.outputs.version }}-x86_64-unknown-linux-musl.tar.gz"
            "sqlfmt-v${{ steps.version.outputs.version }}-aarch64-unknown-linux-musl.tar.gz"
            "sqlfmt-v${{ steps.version.outputs.version }}-x86_64-apple-darwin.tar.gz"
            "sqlfmt-v${{ steps.version.outputs.version }}-aarch64-apple-darwin.tar.gz"
          )
          echo "Expected artifacts:"
          for f in "${EXPECTED[@]}"; do
            echo "  - $f"
            if [ ! -f "artifacts/$f" ]; then
              echo "ERROR: Missing artifact: $f"
              exit 1
            fi
          done
          echo "All 4 platform artifacts present."
          ls -lh artifacts/

      - name: Generate checksums
        run: |
          cd artifacts
          sha256sum *.tar.gz > checksums-sha256.txt
          cat checksums-sha256.txt

      - name: Create or update release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="v${{ steps.version.outputs.version }}"
          TAG="${VERSION}"

          # Create tag if it doesn't exist
          git tag -f "${TAG}"
          git push -f origin "${TAG}"

          # Delete existing release if present (for version bumps on main)
          gh release delete "${TAG}" --yes 2>/dev/null || true

          # Create release with all artifacts
          gh release create "${TAG}" \
            --title "sqlfmt ${VERSION}" \
            --generate-notes \
            artifacts/*.tar.gz \
            artifacts/checksums-sha256.txt
